version: 'Universe.CpuUsage Integration tests on Windows #{build}'
image:
- Ubuntu
- Visual Studio 2019

skip_commits:
  files:
    - .circleci/*

platform: Any CPU
init:
- ps: |

    # copy paste it
    function Say { param( [string] $message )
        Write-Host "$(Get-Elapsed) " -NoNewline -ForegroundColor Magenta
        Write-Host "$message" -ForegroundColor Yellow
    }
    
    function Get-Elapsed
    {
        if ($Global:startAt -eq $null) { $Global:startAt = [System.Diagnostics.Stopwatch]::StartNew(); }
        [System.String]::Concat("[", (new-object System.DateTime(0)).AddMilliseconds($Global:startAt.ElapsedMilliseconds).ToString("mm:ss"), "]");
    }; Get-Elapsed | out-null;


install:
- ps: '$Env:ARTIFACT = "$($Env:APPVEYOR_BUILD_FOLDER)\Artifact"; mkdir $Env:ARTIFACT | out-null; Say "ARTIFACT folder: $($Env:ARTIFACT)"'
- ps: '$Env:SQL_SETUP_LOG_FOLDER = $Env:ARTIFACT; Say "SQL_SETUP_LOG_FOLDER is [$($Env:SQL_SETUP_LOG_FOLDER)]"'
- ps: Start-Transcript "Artifact\Detailed-Build.log" -Force
- git submodule update --init --recursive
- ps: |

    Say "Install Complete"

before_build:
- ps: | 
    
    # Upgrade-PSReadLine

build_script:
- ps: | 
      Say "RESTORE and BUILD"
      & dotnet restore

      pushd Universe.CpuUsage
      & dotnet test -f netcoreapp3.0
      & msbuild /t:rebuild /p:Configuration=Release /v:q
      & msbuild /t:rebuild /p:Configuration=Debug /v:q
      & msbuild /t:pack /p:Configuration=Release /v:q
      & msbuild /t:pack /p:Configuration=Debug /v:q
      popd



after_build:

test_script:
- ps: |
    Say ".NET Core Tests"
    pushd Universe.CpuUsage.Tests 
    & dotnet test -f netcoreapp3.0
    popd

- ps: |
    Say ".NET Framework Tests"
    dotnet build -f net46 -c Debug
    pushd "Universe.CpuUsage.Tests\bin\Debug\net46"
    nunit3-console Universe.CpuUsage.Tests.dll --workers=1 "--result=Universe.CpuUsage.Tests.Result.xml;format=AppVeyor"
    popd


    # & nunit3-console $assembly --workers=1 "--result=$($file).xml;format=AppVeyor"

- ps: | 

    Say "Pack working folder as the 'AppVeyor Build Folder.7z' artifact"
    & "7z" a -t7z -mx=3 -ms=on "AppVeyor Build Folder.7z" .
    Say "Bye-bye"

after_test:
- ps: Stop-Transcript;
# - cmd: bash -c 'time echo "Hello from $(bash --version)"'

# Error uploading artifact the storage: The underlying connection was closed: An unexpected error occurred on a send.
artifacts:
 - path: Artifact
 - path: 'AppVeyor Build Folder.7z'
